name: Build APK with EAS and publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build (EAS) and Publish Release
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }} # required
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install -g eas-cli
          sudo apt-get update && sudo apt-get install -y jq

      - name: Start EAS build and wait
        id: eas_build
        run: |
          # Start a build and wait for it to finish. Output JSON to file.
          eas build -p android --profile apk --non-interactive --wait --json > eas-build.json
          cat eas-build.json

      - name: Extract artifact URL
        id: parse
        run: |
          ARTIFACT_URL=$(jq -r '.artifacts[].url // .artifacts[]?.uri // .artifactUrl // .url' eas-build.json | sed -n '1p')
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT

      - name: Download artifact
        if: steps.parse.outputs.artifact_url != ''
        run: |
          echo "Downloading ${{ steps.parse.outputs.artifact_url }}"
          curl -L "${{ steps.parse.outputs.artifact_url }}" -o blessed-sapphire.apk

      - name: Create GitHub release for tag
        id: create_release
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Creating release for $TAG_NAME"
          RESPONSE=$(curl -s -X POST "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\": \"$TAG_NAME\", \"name\": \"$TAG_NAME\", \"draft\": false, \"prerelease\": false}")
          echo "$RESPONSE" | jq .
          RELEASE_ID=$(echo "$RESPONSE" | jq -r .id)
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT

      - name: Upload APK to Release
        if: steps.parse.outputs.artifact_url != ''
        run: |
          RELEASE_ID=${{ steps.create_release.outputs.release_id }}
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Failed to create release or find release id"; exit 1
          fi
          echo "Uploading blessed-sapphire.apk to release $RELEASE_ID"
          curl --progress-bar -X POST "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=blessed-sapphire.apk" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @blessed-sapphire.apk

      - name: Success
        run: echo "Build and release finished."
